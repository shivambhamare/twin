name: Build & compare with main

on:
  push:
    branches:
      - '**'

jobs:
  build-and-compare:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout the current branch (main / dev / feature / etc.)
      - name: Checkout current branch
        uses: actions/checkout@v4

      # 2) Build artifact for the CURRENT branch
      - name: Build artifact for current branch
        run: |
          mkdir -p build-output
          # ðŸ” Replace this with your real build commands
          # Example:
          #   npm install
          #   npm run build --output-path=build-output
          echo "${{ github.ref_name }} build $(date)" > build-output/app.txt
      # 3) If this is MAIN: just upload the artifact (no compare)
      - name: Upload main artifact (only on main)
        if: github.ref_name == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: main-artifact
          path: build-output/

      # 4) For NON-main branches: checkout MAIN in a separate folder
      - name: Checkout main branch
        if: github.ref_name != 'main'
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-src

      # 5) For NON-main branches: build artifact for MAIN (same build commands)
      - name: Build artifact for main branch
        if: github.ref_name != 'main'
        run: |
          cd main-src
          mkdir -p build-output
          # ðŸ” Use EXACT same build commands as above
          echo "main build $(date)" > build-output/app.txt
      # 6) For NON-main branches: compare MAIN artifact vs CURRENT branch artifact
      - name: Generate diff-with-main.txt
        if: github.ref_name != 'main'
        run: |
          mkdir -p diff-output
          echo "=== Diff: main vs ${{ github.ref_name }} ===" > diff-output/diff-with-main.txt
          echo "" >> diff-output/diff-with-main.txt
          echo ">> listing main build-output"
          ls -R main-src/build-output || echo "no main build-output"
          echo ">> listing current branch build-output"
          ls -R build-output || echo "no current build-output"
          # Compare main build vs current branch build
          # -ru = recursive, unified diff
          diff -ru main-src/build-output build-output >> diff-output/diff-with-main.txt || true
      # 7) Upload diff artifact (only for non-main branches)
      - name: Upload diff-with-main artifact
        if: github.ref_name != 'main'
        uses: actions/upload-artifact@v4
        with:
          name: diff-with-main
          path: diff-output/diff-with-main.txt

      # 8) (Optional) upload artifact for non-main branches too
      - name: Upload branch artifact (non-main)
        if: github.ref_name != 'main'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.ref_name }}-artifact
          path: build-output/
